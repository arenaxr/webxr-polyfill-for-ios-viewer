/**
 * @license
 * webxr-polyfill
 * Copyright (c) 2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * cardboard-vr-display
 * Copyright (c) 2015-2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * webvr-polyfill-dpdb 
 * Copyright (c) 2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * wglu-preserve-state
 * Copyright (c) 2016, Brandon Jones.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
/**
 * @license
 * nosleep.js
 * Copyright (c) 2017, Rich Tibbett
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.WebXRPolyfill=t()}(this,function(){"use strict";const e="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},t=Symbol("@@webxr-polyfill/EventTarget");class i{constructor(){this[t]={listeners:new Map}}addEventListener(e,i){if("string"!=typeof e)throw new Error("`type` must be a string");if("function"!=typeof i)throw new Error("`listener` must be a function");const r=this[t].listeners.get(e)||[];r.push(i),this[t].listeners.set(e,r)}removeEventListener(e,i){if("string"!=typeof e)throw new Error("`type` must be a string");if("function"!=typeof i)throw new Error("`listener` must be a function");const r=this[t].listeners.get(e)||[];for(let e=r.length;e>=0;e--)r[e]===i&&r.pop()}dispatchEvent(e,i){const r=this[t].listeners.get(e)||[],n=[];for(let e=0;e<r.length;e++)n[e]=r[e];for(let e of n)e(i);"function"==typeof this[`on${e}`]&&this[`on${e}`](i)}}const r=Symbol("@@webxr-polyfill/XR"),n="Polyfill Error: Must call navigator.xr.supportsSession() with any XRSessionMode\nor navigator.xr.requestSession('inline') prior to requesting an immersive\nsession. This is a limitation specific to the WebXR Polyfill and does not apply\nto native implementations of the API.";let s;if("performance"in e==!1){let e=Date.now();s=(()=>Date.now()-e)}else s=(()=>performance.now());var o=s;const a=Symbol("@@webxr-polyfill/XRPose");class l{constructor(e,t){this[a]={transform:e,emulatedPosition:t}}get transform(){return this[a].transform}get emulatedPosition(){return this[a].emulatedPosition}_setTransform(e){this[a].transform=e}}const h=1e-6;let c="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function d(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function u(e,t){let i=t[0],r=t[1],n=t[2],s=t[3],o=t[4],a=t[5],l=t[6],h=t[7],c=t[8],d=t[9],u=t[10],f=t[11],p=t[12],v=t[13],w=t[14],m=t[15],y=i*a-r*o,g=i*l-n*o,b=i*h-s*o,S=r*l-n*a,x=r*h-s*a,R=n*h-s*l,M=c*v-d*p,E=c*w-u*p,F=c*m-f*p,X=d*w-u*v,P=d*m-f*v,V=u*m-f*w,O=y*V-g*P+b*X+S*F-x*E+R*M;return O?(O=1/O,e[0]=(a*V-l*P+h*X)*O,e[1]=(n*P-r*V-s*X)*O,e[2]=(v*R-w*x+m*S)*O,e[3]=(u*x-d*R-f*S)*O,e[4]=(l*F-o*V-h*E)*O,e[5]=(i*V-n*F+s*E)*O,e[6]=(w*b-p*R-m*g)*O,e[7]=(c*R-u*b+f*g)*O,e[8]=(o*P-a*F+h*M)*O,e[9]=(r*F-i*P-s*M)*O,e[10]=(p*x-v*b+m*y)*O,e[11]=(d*b-c*x-f*y)*O,e[12]=(a*E-o*X-l*M)*O,e[13]=(i*X-r*E+n*M)*O,e[14]=(v*g-p*S-w*y)*O,e[15]=(c*S-d*g+u*y)*O,e):null}function f(e,t,i){let r=t[0],n=t[1],s=t[2],o=t[3],a=t[4],l=t[5],h=t[6],c=t[7],d=t[8],u=t[9],f=t[10],p=t[11],v=t[12],w=t[13],m=t[14],y=t[15],g=i[0],b=i[1],S=i[2],x=i[3];return e[0]=g*r+b*a+S*d+x*v,e[1]=g*n+b*l+S*u+x*w,e[2]=g*s+b*h+S*f+x*m,e[3]=g*o+b*c+S*p+x*y,g=i[4],b=i[5],S=i[6],x=i[7],e[4]=g*r+b*a+S*d+x*v,e[5]=g*n+b*l+S*u+x*w,e[6]=g*s+b*h+S*f+x*m,e[7]=g*o+b*c+S*p+x*y,g=i[8],b=i[9],S=i[10],x=i[11],e[8]=g*r+b*a+S*d+x*v,e[9]=g*n+b*l+S*u+x*w,e[10]=g*s+b*h+S*f+x*m,e[11]=g*o+b*c+S*p+x*y,g=i[12],b=i[13],S=i[14],x=i[15],e[12]=g*r+b*a+S*d+x*v,e[13]=g*n+b*l+S*u+x*w,e[14]=g*s+b*h+S*f+x*m,e[15]=g*o+b*c+S*p+x*y,e}function p(){let e=new c(3);return c!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function v(e,t,i){let r=new c(3);return r[0]=e,r[1]=t,r[2]=i,r}function w(e,t,i){let r=t[0],n=t[1],s=t[2],o=i[0],a=i[1],l=i[2];return e[0]=n*l-s*a,e[1]=s*o-r*l,e[2]=r*a-n*o,e}const m=function(e){let t=e[0],i=e[1],r=e[2];return Math.sqrt(t*t+i*i+r*r)};!function(){let e=p()}();!function(){let e=function(){let e=new c(4);return c!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}()}();function y(){let e=new c(4);return c!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function g(e,t,i,r){let n,s,o,a,l,c=t[0],d=t[1],u=t[2],f=t[3],p=i[0],v=i[1],w=i[2],m=i[3];return(s=c*p+d*v+u*w+f*m)<0&&(s=-s,p=-p,v=-v,w=-w,m=-m),1-s>h?(n=Math.acos(s),o=Math.sin(n),a=Math.sin((1-r)*n)/o,l=Math.sin(r*n)/o):(a=1-r,l=r),e[0]=a*c+l*p,e[1]=a*d+l*v,e[2]=a*u+l*w,e[3]=a*f+l*m,e}const b=function(e,t,i,r){let n=new c(4);return n[0]=e,n[1]=t,n[2]=i,n[3]=r,n},S=function(e,t){let i=t[0],r=t[1],n=t[2],s=t[3],o=i*i+r*r+n*n+s*s;return o>0&&(o=1/Math.sqrt(o),e[0]=i*o,e[1]=r*o,e[2]=n*o,e[3]=s*o),e},x=(function(){let e=p(),t=v(1,0,0),i=v(0,1,0)}(),function(){let e=y(),t=y()}(),function(){let e=function(){let e=new c(9);return c!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}()}(),Symbol("@@webxr-polyfill/XRRigidTransform"));class R{constructor(){if(this[x]={matrix:null,position:null,orientation:null,inverse:null},0===arguments.length)this[x].matrix=d(new Float32Array(16));else if(1===arguments.length)arguments[0]instanceof Float32Array?this[x].matrix=arguments[0]:(this[x].position=this._getPoint(arguments[0]),this[x].orientation=DOMPointReadOnly.fromPoint({x:0,y:0,z:0,w:1}));else{if(2!==arguments.length)throw new Error("Too many arguments!");this[x].position=this._getPoint(arguments[0]),this[x].orientation=this._getPoint(arguments[1])}if(this[x].matrix){let i=p();e=i,t=this[x].matrix,e[0]=t[12],e[1]=t[13],e[2]=t[14],this[x].position=DOMPointReadOnly.fromPoint({x:i[0],y:i[1],z:i[2]});let r=y();!function(e,t){let i=t[0]+t[5]+t[10],r=0;i>0?(r=2*Math.sqrt(i+1),e[3]=.25*r,e[0]=(t[6]-t[9])/r,e[1]=(t[8]-t[2])/r,e[2]=(t[1]-t[4])/r):t[0]>t[5]&&t[0]>t[10]?(r=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/r,e[0]=.25*r,e[1]=(t[1]+t[4])/r,e[2]=(t[8]+t[2])/r):t[5]>t[10]?(r=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/r,e[0]=(t[1]+t[4])/r,e[1]=.25*r,e[2]=(t[6]+t[9])/r):(r=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/r,e[0]=(t[8]+t[2])/r,e[1]=(t[6]+t[9])/r,e[2]=.25*r)}(r,this[x].matrix),this[x].orientation=DOMPointReadOnly.fromPoint({x:r[0],y:r[1],z:r[2],w:r[3]})}else this[x].matrix=d(new Float32Array(16)),function(e,t,i){let r=t[0],n=t[1],s=t[2],o=t[3],a=r+r,l=n+n,h=s+s,c=r*a,d=r*l,u=r*h,f=n*l,p=n*h,v=s*h,w=o*a,m=o*l,y=o*h;e[0]=1-(f+v),e[1]=d+y,e[2]=u-m,e[3]=0,e[4]=d-y,e[5]=1-(c+v),e[6]=p+w,e[7]=0,e[8]=u+m,e[9]=p-w,e[10]=1-(c+f),e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1}(this[x].matrix,b(this[x].orientation.x,this[x].orientation.y,this[x].orientation.z,this[x].orientation.w),v(this[x].position.x,this[x].position.y,this[x].position.z));var e,t}_getPoint(e){return e instanceof DOMPointReadOnly?e:DOMPointReadOnly.fromPoint(e)}get matrix(){return this[x].matrix}get position(){return this[x].position}get orientation(){return this[x].orientation}get inverse(){if(null===this[x].inverse){let e=d(new Float32Array(16));u(e,this[x].matrix),this[x].inverse=new R(e),this[x].inverse[x].inverse=this}return this[x].inverse}}const M=Symbol("@@webxr-polyfill/XRViewerPose");class E extends l{constructor(e,t){super(new R,!1),this[M]={device:e,views:t,leftViewMatrix:d(new Float32Array(16)),rightViewMatrix:d(new Float32Array(16)),poseModelMatrix:d(new Float32Array(16))}}get poseModelMatrix(){return this[M].poseModelMatrix}get views(){return this[M].views}_updateFromReferenceSpace(e){const t=this[M].device.getBasePoseMatrix(),i=this[M].device.getBaseViewMatrix("left"),r=this[M].device.getBaseViewMatrix("right");t&&(e._transformBasePoseMatrix(this[M].poseModelMatrix,t),e._adjustForOriginOffset(this[M].poseModelMatrix),super._setTransform(new R(this[M].poseModelMatrix))),i&&(e._transformBaseViewMatrix(this[M].leftViewMatrix,i,this[M].poseModelMatrix),f(this[M].leftViewMatrix,this[M].leftViewMatrix,e._originOffsetMatrix())),r&&(e._transformBaseViewMatrix(this[M].rightViewMatrix,r,this[M].poseModelMatrix),f(this[M].rightViewMatrix,this[M].rightViewMatrix,e._originOffsetMatrix()));for(let e of this[M].views)"left"==e.eye?e._updateViewMatrix(this[M].leftViewMatrix):"right"==e.eye&&e._updateViewMatrix(this[M].rightViewMatrix)}}const F=Symbol("@@webxr-polyfill/XRViewport");class X{constructor(e){this[F]={target:e}}get x(){return this[F].target.x}get y(){return this[F].target.y}get width(){return this[F].target.width}get height(){return this[F].target.height}}const P=["left","right"],V=Symbol("@@webxr-polyfill/XRView");class O{constructor(e,t,i){if(!P.includes(t))throw new Error(`XREye must be one of: ${P}`);const r=Object.create(null),n=new X(r);this[V]={device:e,eye:t,viewport:n,temp:r,sessionId:i,transform:null}}get eye(){return this[V].eye}get projectionMatrix(){return this[V].device.getProjectionMatrix(this.eye)}get transform(){return this[V].transform}_updateViewMatrix(e){let t=d(new Float32Array(16));u(t,e),this[V].transform=new R(t)}_getViewport(e){if(this[V].device.getViewport(this[V].sessionId,this.eye,e,this[V].temp))return this[V].viewport}}var L=1e-6,_="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function A(){var e=new _(3);return _!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function C(e,t,i){var r=new _(3);return r[0]=e,r[1]=t,r[2]=i,r}function T(e,t,i){var r=t[0],n=t[1],s=t[2],o=i[0],a=i[1],l=i[2];return e[0]=n*l-s*a,e[1]=s*o-r*l,e[2]=r*a-n*o,e}var j,q=function(e){var t=e[0],i=e[1],r=e[2];return Math.sqrt(t*t+i*i+r*r)};j=A();!function(){var e,t=(e=new _(4),_!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();function I(){var e=new _(4);return _!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function B(e,t,i,r){var n=t[0],s=t[1],o=t[2],a=t[3],l=i[0],h=i[1],c=i[2],d=i[3],u=void 0,f=void 0,p=void 0,v=void 0,w=void 0;return(f=n*l+s*h+o*c+a*d)<0&&(f=-f,l=-l,h=-h,c=-c,d=-d),1-f>L?(u=Math.acos(f),p=Math.sin(u),v=Math.sin((1-r)*u)/p,w=Math.sin(r*u)/p):(v=1-r,w=r),e[0]=v*n+w*l,e[1]=v*s+w*h,e[2]=v*o+w*c,e[3]=v*a+w*d,e}var W,N,D,G,$,k,z,H=function(e,t){var i=t[0],r=t[1],n=t[2],s=t[3],o=i*i+r*r+n*n+s*s;return o>0&&(o=1/Math.sqrt(o),e[0]=i*o,e[1]=r*o,e[2]=n*o,e[3]=s*o),e};W=A(),N=C(1,0,0),D=C(0,1,0),G=I(),$=I(),k=new _(9),_!=Float32Array&&(k[1]=0,k[2]=0,k[3]=0,k[5]=0,k[6]=0,k[7]=0),k[0]=1,k[4]=1,k[8]=1,z=k;!function(){var e,t=(e=new _(2),_!=Float32Array&&(e[0]=0,e[1]=0),e)}();const U=Symbol("@@webxr-polyfill/XRFrame");class J{constructor(e,t,i){const r=[new O(e,"left",i)];t.immersive&&r.push(new O(e,"right",i)),this[U]={device:e,viewerPose:new E(e,r),views:r,session:t}}get session(){return this[U].session}getViewerPose(e){return this[U].viewerPose._updateFromReferenceSpace(e),this[U].viewerPose}getPose(e,t){if("viewer"===e._specialType){let e=this.getViewerPose(t);return new XRPose(new XRRigidTransform(e.poseModelMatrix),e.emulatedPosition)}return"target-ray"===e._specialType||"grip"===e._specialType?this[U].device.getInputPose(e._inputSource,t,e._specialType):null}}const K=Symbol("@@webxr-polyfill/XRSpace");class Q{constructor(e=null,t=null){this[K]={specialType:e,inputSource:t}}get _specialType(){return this[K].specialType}get _inputSource(){return this[K].inputSource}}const Y=1.6,Z=Symbol("@@webxr-polyfill/XRReferenceSpace"),ee=["viewer","local","local-floor","bounded-floor","unbounded"];class te extends Q{constructor(e,t,i){if(!ee.includes(t))throw new Error(`XRReferenceSpaceType must be one of ${ee}`);if(super("viewer"===t?"viewer":null),"bounded-floor"===t&&!i)throw new Error("XRReferenceSpace cannot use 'bounded-floor' type if the platform does not provide the floor level");(function(e){return"bounded-floor"===e||"local-floor"===e})(t)&&!i&&((i=d(new Float32Array(16)))[13]=Y),i||(i=d(new Float32Array(16))),this[Z]={type:t,transform:i,device:e,originOffset:d(new Float32Array(16))}}_transformBasePoseMatrix(e,t){f(e,this[Z].transform,t)}_transformBaseViewMatrix(e,t){u(e,this[Z].transform),f(e,t,e)}_originOffsetMatrix(){return this[Z].originOffset}_adjustForOriginOffset(e){let t=d(new Float32Array(16));u(t,this[Z].originOffset),f(e,t,e)}getOffsetReferenceSpace(e){let t=new te(this[Z].device,this[Z].type,this[Z].transform,this[Z].bounds);return f(t[Z].originOffset,this[Z].originOffset,e.matrix),t}}const ie=Symbol("@@webxr-polyfill/polyfilled-xr-compatible"),re=Symbol("@@webxr-polyfill/xr-compatible"),ne=Symbol("@@webxr-polyfill/XRWebGLLayer"),se=Object.freeze({antialias:!0,depth:!1,stencil:!1,alpha:!0,multiview:!1,ignoreDepthValues:!1,framebufferScaleFactor:1});const oe=Symbol("@@webxr-polyfill/XRInputSourceEvent");class ae extends Event{constructor(e,t){super(e,t),this[oe]={frame:t.frame,inputSource:t.inputSource}}get frame(){return this[oe].frame}get inputSource(){return this[oe].inputSource}}const le=Symbol("@@webxr-polyfill/XRSessionEvent");class he extends Event{constructor(e,t){super(e,t),this[le]={session:t.session}}get session(){return this[le].session}}const ce=Symbol("@@webxr-polyfill/XRSession");class de extends i{constructor(e,t,i){super();let r="inline"!=t;this[ce]={device:e,mode:t,immersive:r,outputContext:null,ended:!1,suspended:!1,suspendedCallback:null,id:i,activeRenderState:null,pendingRenderState:null};const n=new J(e,this,this[ce].id);this[ce].frame=n,this[ce].onPresentationEnd=(t=>{if(t!==this[ce].id){this[ce].suspended=!1,this.dispatchEvent("focus",{session:this});const e=this[ce].suspendedCallback;return this[ce].suspendedCallback=null,void(e&&this.requestAnimationFrame(e))}this[ce].ended=!0,e.removeEventListener("@webvr-polyfill/vr-present-end",this[ce].onPresentationEnd),e.removeEventListener("@webvr-polyfill/vr-present-start",this[ce].onPresentationStart),e.removeEventListener("@@webvr-polyfill/input-select-start",this[ce].onSelectStart),e.removeEventListener("@@webvr-polyfill/input-select-end",this[ce].onSelectEnd),this.dispatchEvent("end",new he("end",{session:this}))}),e.addEventListener("@@webxr-polyfill/vr-present-end",this[ce].onPresentationEnd),this[ce].onPresentationStart=(e=>{e!==this[ce].id&&(this[ce].suspended=!0,this.dispatchEvent("blur",{session:this}))}),e.addEventListener("@@webxr-polyfill/vr-present-start",this[ce].onPresentationStart),this[ce].onSelectStart=(e=>{e.sessionId===this[ce].id&&this.dispatchEvent("selectstart",new ae("selectstart",{frame:this[ce].frame,inputSource:e.inputSource}))}),e.addEventListener("@@webxr-polyfill/input-select-start",this[ce].onSelectStart),this[ce].onSelectEnd=(e=>{e.sessionId===this[ce].id&&(this.dispatchEvent("selectend",new ae("selectend",{frame:this[ce].frame,inputSource:e.inputSource})),this.dispatchEvent("select",new ae("select",{frame:this[ce].frame,inputSource:e.inputSource})))}),e.addEventListener("@@webxr-polyfill/input-select-end",this[ce].onSelectEnd),this.onblur=void 0,this.onfocus=void 0,this.onresetpose=void 0,this.onend=void 0,this.onselect=void 0,this.onselectstart=void 0,this.onselectend=void 0}get renderState(){return this[ce].activeRenderState}get immersive(){return this[ce].immersive}get outputContext(){return this[ce].outputContext}get depthNear(){return this[ce].device.depthNear}set depthNear(e){this[ce].device.depthNear=e}get depthFar(){return this[ce].device.depthFar}set depthFar(e){this[ce].device.depthFar=e}get environmentBlendMode(){return this[ce].device.environmentBlendMode||"opaque"}get baseLayer(){return this[ce].baseLayer}set baseLayer(e){this[ce].ended||(this[ce].baseLayer=e,this[ce].device.onBaseLayerSet(this[ce].id,e))}async requestReferenceSpace(e){if(this[ce].ended)return;if("unbounded"===e)throw new NotSupportedError(`The WebXR polyfill does not support the ${e} reference space`);if(!ee.includes(e))throw new TypeError(`XRReferenceSpaceType must be one of ${ee}`);let t=await this[ce].device.requestFrameOfReferenceTransform(e);if("bounded-floor"===e){if(!t)throw new NotSupportedError(`${e} XRReferenceSpace not supported by this device.`);if(!this[ce].device.requestStageBounds())throw new NotSupportedError(`${e} XRReferenceSpace not supported by this device.`);throw new NotSupportedError(`The WebXR polyfill does not support the ${e} reference space yet.`)}return new te(this[ce].device,e,t)}requestAnimationFrame(e){if(!(this[ce].ended||this[ce].suspended&&this[ce].suspendedCallback))return this[ce].suspended&&!this[ce].suspendedCallback&&(this[ce].suspendedCallback=e),this[ce].device.requestAnimationFrame(()=>{null!==this[ce].pendingRenderState&&(this[ce].activeRenderState=this[ce].pendingRenderState,this[ce].pendingRenderState=null,this[ce].activeRenderState.baseLayer&&this[ce].device.onBaseLayerSet(this[ce].id,this[ce].activeRenderState.baseLayer),this[ce].activeRenderState.inlineVerticalFieldOfView&&this[ce].device.onInlineVerticalFieldOfViewSet(this[ce].id,this[ce].activeRenderState.inlineVerticalFieldOfView)),this[ce].device.onFrameStart(this[ce].id),e(o(),this[ce].frame),this[ce].device.onFrameEnd(this[ce].id)})}cancelAnimationFrame(e){this[ce].ended||this[ce].device.cancelAnimationFrame(e)}get inputSources(){return this[ce].device.getInputSources()}async end(){if(!this[ce].ended)return this.immersive||(this[ce].ended=!0,this[ce].device.removeEventListener("@@webvr-polyfill/vr-present-start",this[ce].onPresentationStart),this[ce].device.removeEventListener("@@webvr-polyfill/vr-present-end",this[ce].onPresentationEnd),this[ce].device.removeEventListener("@@webvr-polyfill/input-select-start",this[ce].onSelectStart),this[ce].device.removeEventListener("@@webvr-polyfill/input-select-end",this[ce].onSelectEnd),this.dispatchEvent("end",new he("end",{session:this}))),this[ce].device.endSession(this[ce].id)}updateRenderState(e){if(this[ce].ended){throw new Error("Can't call updateRenderState on an XRSession that has already ended.")}if(e.baseLayer&&e.baseLayer._session!==this){throw new Error("Called updateRenderState with a base layer that was created by a different session.")}if(null!==e.inlineVerticalFieldOfView&&void 0!==e.inlineVerticalFieldOfView){if(this[ce].immersive){throw new Error("inlineVerticalFieldOfView must not be set for an XRRenderState passed to updateRenderState for an immersive session.")}e.inlineVerticalFieldOfView=Math.min(3.13,Math.max(.01,e.inlineVerticalFieldOfView))}null===this[ce].pendingRenderState&&(this[ce].pendingRenderState=Object.assign({},this[ce].activeRenderState,e))}}const ue=Symbol("@@webxr-polyfill/XRInputSource");const fe=Symbol("@@webxr-polyfill/XRInputSourcesChangeEvent");const pe=Symbol("@@webxr-polyfill/XRReferenceSpaceEvent");const ve=Symbol("@@webxr-polyfill/XRRenderState"),we=Object.freeze({depthNear:.1,depthFar:1e3,inlineVerticalFieldOfView:null,baseLayer:null});var me={XR:class extends i{constructor(e){super(),this[r]={device:null,devicePromise:e,immersiveSession:null,inlineSessions:new Set},e.then(e=>{this[r].device=e})}async supportsSession(e){return this[r].device||await this[r].devicePromise,"inline"==e||this[r].device.supportsSession(e)?Promise.resolve():Promise.reject(new DOMException("The specified session configuration is not supported."))}async requestSession(e){if(!this[r].device){if("inline"!=e)throw new Error(n);await this[r].devicePromise}const t=await this[r].device.requestSession(e),i=new XRSession(this[r].device,e,t);"inline"==e?this[r].inlineSessions.add(i):this[r].immersiveSession=i;const s=()=>{"inline"==e?this[r].inlineSessions.delete(i):this[r].immersiveSession=null,i.removeEventListener("end",s)};return i.addEventListener("end",s),i}},XRSession:de,XRSessionEvent:he,XRFrame:J,XRView:O,XRViewport:X,XRViewerPose:E,XRWebGLLayer:class{constructor(e,t,i={}){const r=Object.assign({},se,i);if(!(e instanceof de))throw new Error("session must be a XRSession");if(e.ended)throw new Error("InvalidStateError");if(t[ie]&&!0!==t[re])throw new Error("InvalidStateError");const n=t.getParameter(t.FRAMEBUFFER_BINDING);this[ne]={context:t,config:r,framebuffer:n,session:e}}get context(){return this[ne].context}get antialias(){return this[ne].config.antialias}get ignoreDepthValues(){return!0}get framebuffer(){return this[ne].framebuffer}get framebufferWidth(){return this[ne].context.drawingBufferWidth}get framebufferHeight(){return this[ne].context.drawingBufferHeight}get _session(){return this[ne].session}getViewport(e){return e._getViewport(this)}},XRSpace:Q,XRReferenceSpace:te,XRReferenceSpaceEvent:class extends Event{constructor(e,t){super(e,t),this[pe]={referenceSpace:t.referenceSpace,transform:t.transform||null}}get referenceSpace(){return this[pe].referenceSpace}get transform(){return this[pe].transform}},XRInputSource:class{constructor(e){this[ue]={impl:e,gripSpace:new Q("grip",this),targetRaySpace:new Q("target-ray",this)}}get handedness(){return this[ue].impl.handedness}get targetRayMode(){return this[ue].impl.targetRayMode}get gripSpace(){let e=this[ue].impl.targetRayMode;return"gaze"===e||"screen"===e?null:this[ue].gripSpace}get targetRaySpace(){return this[ue].targetRaySpace}get profiles(){return this[ue].impl.profiles}get gamepad(){return this[ue].impl.gamepad}},XRInputSourceEvent:ae,XRInputSourcesChangeEvent:class extends Event{constructor(e,t){super(e,t),this[fe]={session:t.session,added:t.added,removed:t.removed}}get session(){return this[fe].session}get added(){return this[fe].added}get removed(){return this[fe].removed}},XRRenderState:class{constructor(e={}){const t=Object.assign({},we,e);this[ve]={config:t}}get depthNear(){return this[ve].depthNear}get depthFar(){return this[ve].depthFar}get inlineVerticalFieldOfView(){return this[ve].inlineVerticalFieldOfView}get baseLayer(){return this[ve].baseLayer}},XRRigidTransform:R,XRPose:l};const ye=e=>"function"!=typeof e.prototype.makeXRCompatible&&(e.prototype.makeXRCompatible=function(){return this[re]=!0,Promise.resolve()},!0),ge=e=>{const t=e.prototype.getContext;e.prototype.getContext=function(e,i){const r=t.call(this,e,i);return r&&(r[ie]=!0,i&&"xrCompatible"in i&&(r[re]=i.xrCompatible)),r}},be=async function(e,t){return null},Se={global:e,webvr:!0,cardboard:!0,cardboardConfig:null,allowCardboardOnDesktop:!1},xe=["navigator","HTMLCanvasElement","WebGLRenderingContext"];return class{constructor(e={}){this.config=Object.freeze(Object.assign({},Se,e)),this.global=this.config.global,this.nativeWebXR="xr"in this.global.navigator,this.injected=!1,this.nativeWebXR?this._injectCompatibilityShims(this.global):this._injectPolyfill(this.global)}_injectPolyfill(e){if(!xe.every(t=>!!e[t]))throw new Error(`Global must have the following attributes : ${xe}`);for(const t of Object.keys(me))void 0!==e[t]?console.warn(`${t} already defined on global.`):e[t]=me[t];ye(e.WebGLRenderingContext)&&(ge(e.HTMLCanvasElement),e.OffscreenCanvas&&ge(e.OffscreenCanvas),e.WebGL2RenderingContext&&ye(e.WebGL2RenderingContext)),this.injected=!0,this._patchNavigatorXR()}_patchNavigatorXR(){let e=be(this.global,this.config);this.xr=new XR(e),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}_injectCompatibilityShims(e){if(!xe.every(t=>!!e[t]))throw new Error(`Global must have the following attributes : ${xe}`);if(e.XRWebGLLayer){let i=e.navigator.xr.requestSession;e.navigator.xr.requestSession=function(e,t){return i.call(this,e,t).then(t=>(t._session_mode=e,t))};var t=e.XRWebGLLayer;e.XRWebGLLayer=function(e,i,r){return r||(r={}),r.compositionDisabled="inline"===e._session_mode,new t(e,i,r)}}}}});
