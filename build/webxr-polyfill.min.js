/**
 * @license
 * webxr-polyfill
 * Copyright (c) 2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * cardboard-vr-display
 * Copyright (c) 2015-2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * webvr-polyfill-dpdb 
 * Copyright (c) 2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * wglu-preserve-state
 * Copyright (c) 2016, Brandon Jones.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
/**
 * @license
 * nosleep.js
 * Copyright (c) 2017, Rich Tibbett
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.WebXRPolyfill=t()}(this,function(){"use strict";const e="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},t=Symbol("@@webxr-polyfill/EventTarget");class i{constructor(){this[t]={listeners:new Map}}addEventListener(e,i){if("string"!=typeof e)throw new Error("`type` must be a string");if("function"!=typeof i)throw new Error("`listener` must be a function");const r=this[t].listeners.get(e)||[];r.push(i),this[t].listeners.set(e,r)}removeEventListener(e,i){if("string"!=typeof e)throw new Error("`type` must be a string");if("function"!=typeof i)throw new Error("`listener` must be a function");const r=this[t].listeners.get(e)||[];for(let e=r.length;e>=0;e--)r[e]===i&&r.pop()}dispatchEvent(e,i){const r=this[t].listeners.get(e)||[],n=[];for(let e=0;e<r.length;e++)n[e]=r[e];for(let e of n)e(i);"function"==typeof this[`on${e}`]&&this[`on${e}`](i)}}const r=1e-6;let n="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function s(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function o(e,t){let i=t[0],r=t[1],n=t[2],s=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],u=t[9],d=t[10],p=t[11],f=t[12],v=t[13],m=t[14],w=t[15],g=i*a-r*o,S=i*l-n*o,y=i*c-s*o,b=r*l-n*a,x=r*c-s*a,R=n*c-s*l,E=h*v-u*f,F=h*m-d*f,M=h*w-p*f,P=u*m-d*v,X=u*w-p*v,_=d*w-p*m,O=g*_-S*X+y*P+b*M-x*F+R*E;return O?(O=1/O,e[0]=(a*_-l*X+c*P)*O,e[1]=(n*X-r*_-s*P)*O,e[2]=(v*R-m*x+w*b)*O,e[3]=(d*x-u*R-p*b)*O,e[4]=(l*M-o*_-c*F)*O,e[5]=(i*_-n*M+s*F)*O,e[6]=(m*y-f*R-w*S)*O,e[7]=(h*R-d*y+p*S)*O,e[8]=(o*X-a*M+c*E)*O,e[9]=(r*M-i*X-s*E)*O,e[10]=(f*x-v*y+w*g)*O,e[11]=(u*y-h*x-p*g)*O,e[12]=(a*F-o*P-l*E)*O,e[13]=(i*P-r*F+n*E)*O,e[14]=(v*S-f*b-m*g)*O,e[15]=(h*b-u*S+d*g)*O,e):null}function a(e,t,i){let r=t[0],n=t[1],s=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],u=t[8],d=t[9],p=t[10],f=t[11],v=t[12],m=t[13],w=t[14],g=t[15],S=i[0],y=i[1],b=i[2],x=i[3];return e[0]=S*r+y*a+b*u+x*v,e[1]=S*n+y*l+b*d+x*m,e[2]=S*s+y*c+b*p+x*w,e[3]=S*o+y*h+b*f+x*g,S=i[4],y=i[5],b=i[6],x=i[7],e[4]=S*r+y*a+b*u+x*v,e[5]=S*n+y*l+b*d+x*m,e[6]=S*s+y*c+b*p+x*w,e[7]=S*o+y*h+b*f+x*g,S=i[8],y=i[9],b=i[10],x=i[11],e[8]=S*r+y*a+b*u+x*v,e[9]=S*n+y*l+b*d+x*m,e[10]=S*s+y*c+b*p+x*w,e[11]=S*o+y*h+b*f+x*g,S=i[12],y=i[13],b=i[14],x=i[15],e[12]=S*r+y*a+b*u+x*v,e[13]=S*n+y*l+b*d+x*m,e[14]=S*s+y*c+b*p+x*w,e[15]=S*o+y*h+b*f+x*g,e}function l(){let e=new n(3);return n!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function c(e,t,i){let r=new n(3);return r[0]=e,r[1]=t,r[2]=i,r}function h(e,t,i){let r=t[0],n=t[1],s=t[2],o=i[0],a=i[1],l=i[2];return e[0]=n*l-s*a,e[1]=s*o-r*l,e[2]=r*a-n*o,e}const u=function(e){let t=e[0],i=e[1],r=e[2];return Math.sqrt(t*t+i*i+r*r)};!function(){let e=l()}();!function(){let e=function(){let e=new n(4);return n!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}()}();function d(){let e=new n(4);return n!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function p(e,t,i,n){let s,o,a,l,c,h=t[0],u=t[1],d=t[2],p=t[3],f=i[0],v=i[1],m=i[2],w=i[3];return(o=h*f+u*v+d*m+p*w)<0&&(o=-o,f=-f,v=-v,m=-m,w=-w),1-o>r?(s=Math.acos(o),a=Math.sin(s),l=Math.sin((1-n)*s)/a,c=Math.sin(n*s)/a):(l=1-n,c=n),e[0]=l*h+c*f,e[1]=l*u+c*v,e[2]=l*d+c*m,e[3]=l*p+c*w,e}const f=function(e,t,i,r){let s=new n(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s},v=function(e,t){let i=t[0],r=t[1],n=t[2],s=t[3],o=i*i+r*r+n*n+s*s;return o>0&&(o=1/Math.sqrt(o),e[0]=i*o,e[1]=r*o,e[2]=n*o,e[3]=s*o),e},m=(function(){let e=l(),t=c(1,0,0),i=c(0,1,0)}(),function(){let e=d(),t=d()}(),function(){let e=function(){let e=new n(9);return n!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}()}(),Symbol("@@webxr-polyfill/XRRigidTransform"));class w{constructor(){if(this[m]={matrix:null,position:null,orientation:null,inverse:null},0===arguments.length)this[m].matrix=s(new Float32Array(16));else if(1===arguments.length)arguments[0]instanceof Float32Array?this[m].matrix=arguments[0]:(this[m].position=this._getPoint(arguments[0]),this[m].orientation=DOMPointReadOnly.fromPoint({x:0,y:0,z:0,w:1}));else{if(2!==arguments.length)throw new Error("Too many arguments!");this[m].position=this._getPoint(arguments[0]),this[m].orientation=this._getPoint(arguments[1])}if(this[m].matrix){let i=l();e=i,t=this[m].matrix,e[0]=t[12],e[1]=t[13],e[2]=t[14],this[m].position=DOMPointReadOnly.fromPoint({x:i[0],y:i[1],z:i[2]});let r=d();!function(e,t){let i=t[0]+t[5]+t[10],r=0;i>0?(r=2*Math.sqrt(i+1),e[3]=.25*r,e[0]=(t[6]-t[9])/r,e[1]=(t[8]-t[2])/r,e[2]=(t[1]-t[4])/r):t[0]>t[5]&&t[0]>t[10]?(r=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/r,e[0]=.25*r,e[1]=(t[1]+t[4])/r,e[2]=(t[8]+t[2])/r):t[5]>t[10]?(r=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/r,e[0]=(t[1]+t[4])/r,e[1]=.25*r,e[2]=(t[6]+t[9])/r):(r=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/r,e[0]=(t[8]+t[2])/r,e[1]=(t[6]+t[9])/r,e[2]=.25*r)}(r,this[m].matrix),this[m].orientation=DOMPointReadOnly.fromPoint({x:r[0],y:r[1],z:r[2],w:r[3]})}else this[m].matrix=s(new Float32Array(16)),function(e,t,i){let r=t[0],n=t[1],s=t[2],o=t[3],a=r+r,l=n+n,c=s+s,h=r*a,u=r*l,d=r*c,p=n*l,f=n*c,v=s*c,m=o*a,w=o*l,g=o*c;e[0]=1-(p+v),e[1]=u+g,e[2]=d-w,e[3]=0,e[4]=u-g,e[5]=1-(h+v),e[6]=f+m,e[7]=0,e[8]=d+w,e[9]=f-m,e[10]=1-(h+p),e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1}(this[m].matrix,f(this[m].orientation.x,this[m].orientation.y,this[m].orientation.z,this[m].orientation.w),c(this[m].position.x,this[m].position.y,this[m].position.z));var e,t}_getPoint(e){return e instanceof DOMPointReadOnly?e:DOMPointReadOnly.fromPoint(e)}get matrix(){return this[m].matrix}get position(){return this[m].position}get orientation(){return this[m].orientation}get inverse(){if(null===this[m].inverse){let e=s(new Float32Array(16));o(e,this[m].matrix),this[m].inverse=new w(e),this[m].inverse[m].inverse=this}return this[m].inverse}}const g=Symbol("@@webxr-polyfill/XRSpace");class S{constructor(e=null,t=null){this[g]={specialType:e,inputSource:t,baseMatrix:null,inverseBaseMatrix:null,lastFrameId:-1}}get _specialType(){return this[g].specialType}get _inputSource(){return this[g].inputSource}_ensurePoseUpdated(e,t){t!=this[g].lastFrameId&&(this[g].lastFrameId=t,this._onPoseUpdate(e))}_onPoseUpdate(e){"viewer"==this[g].specialType&&(this._baseMatrix=e.getBasePoseMatrix())}set _baseMatrix(e){this[g].baseMatrix=e,this[g].inverseBaseMatrix=null}get _baseMatrix(){return this[g].baseMatrix||this[g].inverseBaseMatrix&&(this[g].baseMatrix=new Float32Array(16),o(this[g].baseMatrix,this[g].inverseBaseMatrix)),this[g].baseMatrix}set _inverseBaseMatrix(e){this[g].inverseBaseMatrix=e,this[g].baseMatrix=null}get _inverseBaseMatrix(){return this[g].inverseBaseMatrix||this[g].baseMatrix&&(this[g].inverseBaseMatrix=new Float32Array(16),o(this[g].inverseBaseMatrix,this[g].baseMatrix)),this[g].inverseBaseMatrix}_getSpaceRelativeTransform(e){if(!this._inverseBaseMatrix||!e._baseMatrix)return null;let t=new Float32Array(16);return a(t,this._inverseBaseMatrix,e._baseMatrix),new w(t)}}const y=1.6,b=Symbol("@@webxr-polyfill/XRReferenceSpace"),x=["viewer","local","local-floor","bounded-floor","unbounded"];class R extends S{constructor(e,t=null){if(!x.includes(e))throw new Error(`XRReferenceSpaceType must be one of ${x}`);if(super(e),"bounded-floor"===e&&!t)throw new Error("XRReferenceSpace cannot use 'bounded-floor' type if the platform does not provide the floor level");(function(e){return"bounded-floor"===e||"local-floor"===e})(e)&&!t&&((t=s(new Float32Array(16)))[13]=y),this._inverseBaseMatrix=t||s(new Float32Array(16)),this[b]={type:e,originOffset:s(new Float32Array(16))}}_onPoseUpdate(e){switch(this[b].type){case"viewer":this._baseMatrix=e.getBasePoseMatrix()}}_transformBasePoseMatrix(e,t){a(e,this._inverseBaseMatrix,t)}_originOffsetMatrix(){return this[b].originOffset}_adjustForOriginOffset(e){let t=new Float32Array(16);o(t,this[b].originOffset),a(e,t,e)}_getSpaceRelativeTransform(e){let t=super._getSpaceRelativeTransform(e);return this._adjustForOriginOffset(t.matrix),new XRRigidTransform(t.matrix)}getOffsetReferenceSpace(e){let t=new R(this[b].type,this[b].transform,this[b].bounds);return a(t[b].originOffset,this[b].originOffset,e.matrix),t}}const E=Symbol("@@webxr-polyfill/XR"),F=["inline","immersive-vr","immersive-ar"],M={inline:{requiredFeatures:["viewer"],optionalFeatures:[]},"immersive-vr":{requiredFeatures:["viewer","local"],optionalFeatures:[]},"immersive-ar":{requiredFeatures:["viewer","local"],optionalFeatures:[]}},P="Polyfill Error: Must call navigator.xr.isSessionSupported() with any XRSessionMode\nor navigator.xr.requestSession('inline') prior to requesting an immersive\nsession. This is a limitation specific to the WebXR Polyfill and does not apply\nto native implementations of the API.";let X;if("performance"in e==!1){let e=Date.now();X=(()=>Date.now()-e)}else X=(()=>performance.now());var _=X;const O=Symbol("@@webxr-polyfill/XRPose");class L{constructor(e,t){this[O]={transform:e,emulatedPosition:t}}get transform(){return this[O].transform}get emulatedPosition(){return this[O].emulatedPosition}}const I=Symbol("@@webxr-polyfill/XRViewerPose");class q extends L{constructor(e,t,i=!1){super(e,i),this[I]={views:t}}get views(){return this[I].views}}const V=Symbol("@@webxr-polyfill/XRViewport");class A{constructor(e){this[V]={target:e}}get x(){return this[V].target.x}get y(){return this[V].target.y}get width(){return this[V].target.width}get height(){return this[V].target.height}}const C=["left","right","none"],T=Symbol("@@webxr-polyfill/XRView");class D{constructor(e,t,i,r){if(!C.includes(i))throw new Error(`XREye must be one of: ${C}`);const n=Object.create(null),s=new A(n);this[T]={device:e,eye:i,viewport:s,temp:n,sessionId:r,transform:t}}get eye(){return this[T].eye}get projectionMatrix(){return this[T].device.getProjectionMatrix(this.eye)}get transform(){return this[T].transform}_getViewport(e){if(this[T].device.getViewport(this[T].sessionId,this.eye,e,this[T].temp))return this[T].viewport}}var B=1e-6,j="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function k(){var e=new j(3);return j!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function z(e,t,i){var r=new j(3);return r[0]=e,r[1]=t,r[2]=i,r}function W(e,t,i){var r=t[0],n=t[1],s=t[2],o=i[0],a=i[1],l=i[2];return e[0]=n*l-s*a,e[1]=s*o-r*l,e[2]=r*a-n*o,e}var $,N=function(e){var t=e[0],i=e[1],r=e[2];return Math.sqrt(t*t+i*i+r*r)};$=k();!function(){var e,t=(e=new j(4),j!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();function G(){var e=new j(4);return j!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function H(e,t,i,r){var n=t[0],s=t[1],o=t[2],a=t[3],l=i[0],c=i[1],h=i[2],u=i[3],d=void 0,p=void 0,f=void 0,v=void 0,m=void 0;return(p=n*l+s*c+o*h+a*u)<0&&(p=-p,l=-l,c=-c,h=-h,u=-u),1-p>B?(d=Math.acos(p),f=Math.sin(d),v=Math.sin((1-r)*d)/f,m=Math.sin(r*d)/f):(v=1-r,m=r),e[0]=v*n+m*l,e[1]=v*s+m*c,e[2]=v*o+m*h,e[3]=v*a+m*u,e}var U,J,K,Q,Y,Z,ee,te=function(e,t){var i=t[0],r=t[1],n=t[2],s=t[3],o=i*i+r*r+n*n+s*s;return o>0&&(o=1/Math.sqrt(o),e[0]=i*o,e[1]=r*o,e[2]=n*o,e[3]=s*o),e};U=k(),J=z(1,0,0),K=z(0,1,0),Q=G(),Y=G(),Z=new j(9),j!=Float32Array&&(Z[1]=0,Z[2]=0,Z[3]=0,Z[5]=0,Z[6]=0,Z[7]=0),Z[0]=1,Z[4]=1,Z[8]=1,ee=Z;!function(){var e,t=(e=new j(2),j!=Float32Array&&(e[0]=0,e[1]=0),e)}();const ie=Symbol("@@webxr-polyfill/XRFrame"),re="XRFrame access outside the callback that produced it is invalid.",ne="getViewerPose can only be called on XRFrame objects passed to XRSession.requestAnimationFrame callbacks.";let se=0;class oe{constructor(e,t,i){this[ie]={id:++se,active:!1,animationFrame:!1,device:e,session:t,sessionId:i}}get session(){return this[ie].session}getViewerPose(e){if(!this[ie].animationFrame)throw new DOMException(ne,"InvalidStateError");if(!this[ie].active)throw new DOMException(re,"InvalidStateError");const t=this[ie].device,i=this[ie].session;i[ye].viewerSpace._ensurePoseUpdated(t,this[ie].id),e._ensurePoseUpdated(t,this[ie].id);let r=e._getSpaceRelativeTransform(i[ye].viewerSpace);const n=[];for(let r of i[ye].viewSpaces){r._ensurePoseUpdated(t,this[ie].id);let i=e._getSpaceRelativeTransform(r),s=new D(t,i,r.eye,this[ie].sessionId);n.push(s)}return new q(r,n,!1)}getPose(e,t){if(!this[ie].active)throw new DOMException(re,"InvalidStateError");const i=this[ie].device;if("target-ray"===e._specialType||"grip"===e._specialType)return i.getInputPose(e._inputSource,t,e._specialType);{e._ensurePoseUpdated(i,this[ie].id),t._ensurePoseUpdated(i,this[ie].id);let r=t._getSpaceRelativeTransform(e);return r?new XRPose(r,!1):null}}}const ae=Symbol("@@webxr-polyfill/XRRenderState"),le=Object.freeze({depthNear:.1,depthFar:1e3,inlineVerticalFieldOfView:null,baseLayer:null});class ce{constructor(e={}){const t=Object.assign({},le,e);this[ae]={config:t}}get depthNear(){return this[ae].config.depthNear}get depthFar(){return this[ae].config.depthFar}get inlineVerticalFieldOfView(){return this[ae].config.inlineVerticalFieldOfView}get baseLayer(){return this[ae].config.baseLayer}}const he=Symbol("@@webxr-polyfill/polyfilled-xr-compatible"),ue=Symbol("@@webxr-polyfill/xr-compatible"),de=Symbol("@@webxr-polyfill/XRWebGLLayer"),pe=Object.freeze({antialias:!0,depth:!1,stencil:!1,alpha:!0,multiview:!1,ignoreDepthValues:!1,framebufferScaleFactor:1});const fe=Symbol("@@webxr-polyfill/XRInputSourceEvent");class ve extends Event{constructor(e,t){super(e,t),this[fe]={frame:t.frame,inputSource:t.inputSource}}get frame(){return this[fe].frame}get inputSource(){return this[fe].inputSource}}const me=Symbol("@@webxr-polyfill/XRSessionEvent");class we extends Event{constructor(e,t){super(e,t),this[me]={session:t.session}}get session(){return this[me].session}}const ge=Symbol("@@webxr-polyfill/XRInputSourcesChangeEvent");class Se extends Event{constructor(e,t){super(e,t),this[ge]={session:t.session,added:t.added,removed:t.removed}}get session(){return this[ge].session}get added(){return this[ge].added}get removed(){return this[ge].removed}}const ye=Symbol("@@webxr-polyfill/XRSession");class be extends S{constructor(e){super(e)}get eye(){return this._specialType}_onPoseUpdate(e){this._inverseBaseMatrix=e.getBaseViewMatrix(this._specialType)}}class xe extends i{constructor(e,t,i){super();let r="inline"!=t,n=new ce({inlineVerticalFieldOfView:r?null:.5*Math.PI});this[ye]={device:e,mode:t,immersive:r,ended:!1,suspended:!1,frameCallbacks:[],currentFrameCallbacks:null,frameHandle:0,deviceFrameHandle:null,id:i,activeRenderState:n,pendingRenderState:null,viewerSpace:new R("viewer"),viewSpaces:[],currentInputSources:[]},r?this[ye].viewSpaces.push(new be("left"),new be("right")):this[ye].viewSpaces.push(new be("none")),this[ye].onDeviceFrame=(()=>{if(this[ye].ended||this[ye].suspended)return;if(this[ye].deviceFrameHandle=null,this[ye].startDeviceFrameLoop(),null!==this[ye].pendingRenderState&&(this[ye].activeRenderState=new ce(this[ye].pendingRenderState),this[ye].pendingRenderState=null,this[ye].activeRenderState.baseLayer&&this[ye].device.onBaseLayerSet(this[ye].id,this[ye].activeRenderState.baseLayer)),null===this[ye].activeRenderState.baseLayer)return;const t=new oe(e,this,this[ye].id),i=this[ye].currentFrameCallbacks=this[ye].frameCallbacks;this[ye].frameCallbacks=[],t[ie].active=!0,t[ie].animationFrame=!0,this[ye].device.onFrameStart(this[ye].id,this[ye].activeRenderState),this._checkInputSourcesChange();const r=_();for(let e=0;e<i.length;e++)try{i[e].cancelled||"function"!=typeof i[e].callback||i[e].callback(r,t)}catch(e){console.error(e)}this[ye].currentFrameCallbacks=null,t[ie].active=!1,this[ye].device.onFrameEnd(this[ye].id)}),this[ye].startDeviceFrameLoop=(()=>{null===this[ye].deviceFrameHandle&&(this[ye].deviceFrameHandle=this[ye].device.requestAnimationFrame(this[ye].onDeviceFrame))}),this[ye].stopDeviceFrameLoop=(()=>{const e=this[ye].deviceFrameHandle;null!==e&&(this[ye].device.cancelAnimationFrame(e),this[ye].deviceFrameHandle=null)}),this[ye].onPresentationEnd=(t=>{if(t!==this[ye].id)return this[ye].suspended=!1,this[ye].startDeviceFrameLoop(),void this.dispatchEvent("focus",{session:this});this[ye].ended=!0,this[ye].stopDeviceFrameLoop(),e.removeEventListener("@webvr-polyfill/vr-present-end",this[ye].onPresentationEnd),e.removeEventListener("@webvr-polyfill/vr-present-start",this[ye].onPresentationStart),e.removeEventListener("@@webvr-polyfill/input-select-start",this[ye].onSelectStart),e.removeEventListener("@@webvr-polyfill/input-select-end",this[ye].onSelectEnd),this.dispatchEvent("end",new we("end",{session:this}))}),e.addEventListener("@@webxr-polyfill/vr-present-end",this[ye].onPresentationEnd),this[ye].onPresentationStart=(e=>{e!==this[ye].id&&(this[ye].suspended=!0,this[ye].stopDeviceFrameLoop(),this.dispatchEvent("blur",{session:this}))}),e.addEventListener("@@webxr-polyfill/vr-present-start",this[ye].onPresentationStart),this[ye].onSelectStart=(e=>{e.sessionId===this[ye].id&&this[ye].dispatchInputSourceEvent("selectstart",e.inputSource)}),e.addEventListener("@@webxr-polyfill/input-select-start",this[ye].onSelectStart),this[ye].onSelectEnd=(e=>{e.sessionId===this[ye].id&&(this[ye].dispatchInputSourceEvent("selectend",e.inputSource),this[ye].dispatchInputSourceEvent("select",e.inputSource))}),e.addEventListener("@@webxr-polyfill/input-select-end",this[ye].onSelectEnd),this[ye].onSqueezeStart=(e=>{e.sessionId===this[ye].id&&this[ye].dispatchInputSourceEvent("squeezestart",e.inputSource)}),e.addEventListener("@@webxr-polyfill/input-squeeze-start",this[ye].onSqueezeStart),this[ye].onSqueezeEnd=(e=>{e.sessionId===this[ye].id&&(this[ye].dispatchInputSourceEvent("squeezeend",e.inputSource),this[ye].dispatchInputSourceEvent("squeeze",e.inputSource))}),e.addEventListener("@@webxr-polyfill/input-squeeze-end",this[ye].onSqueezeEnd),this[ye].dispatchInputSourceEvent=((t,i)=>{const r=new oe(e,this,this[ye].id),n=new ve(t,{frame:r,inputSource:i});r[ie].active=!0,this.dispatchEvent(t,n),r[ie].active=!1}),this[ye].startDeviceFrameLoop(),this.onblur=void 0,this.onfocus=void 0,this.onresetpose=void 0,this.onend=void 0,this.onselect=void 0,this.onselectstart=void 0,this.onselectend=void 0}get renderState(){return this[ye].activeRenderState}get environmentBlendMode(){return this[ye].device.environmentBlendMode||"opaque"}async requestReferenceSpace(e){if(this[ye].ended)return;if(!x.includes(e))throw new TypeError(`XRReferenceSpaceType must be one of ${x}`);if(!this[ye].device.doesSessionSupportReferenceSpace(this[ye].id,e))throw new DOMException(`The ${e} reference space is not supported by this session.`,"NotSupportedError");if("viewer"===e)return this[ye].viewerSpace;let t=await this[ye].device.requestFrameOfReferenceTransform(e);if("bounded-floor"===e){if(!t)throw new DOMException(`${e} XRReferenceSpace not supported by this device.`,"NotSupportedError");if(!this[ye].device.requestStageBounds())throw new DOMException(`${e} XRReferenceSpace not supported by this device.`,"NotSupportedError");throw new DOMException(`The WebXR polyfill does not support the ${e} reference space yet.`,"NotSupportedError")}return new R(e,t)}requestAnimationFrame(e){if(this[ye].ended)return;const t=++this[ye].frameHandle;return this[ye].frameCallbacks.push({handle:t,callback:e,cancelled:!1}),t}cancelAnimationFrame(e){let t=this[ye].frameCallbacks,i=t.findIndex(t=>t&&t.handle===e);i>-1&&(t[i].cancelled=!0,t.splice(i,1)),(t=this[ye].currentFrameCallbacks)&&(i=t.findIndex(t=>t&&t.handle===e))>-1&&(t[i].cancelled=!0)}get inputSources(){return this[ye].device.getInputSources()}async end(){if(!this[ye].ended)return this.immersive&&(this[ye].ended=!0,this[ye].device.removeEventListener("@@webvr-polyfill/vr-present-start",this[ye].onPresentationStart),this[ye].device.removeEventListener("@@webvr-polyfill/vr-present-end",this[ye].onPresentationEnd),this[ye].device.removeEventListener("@@webvr-polyfill/input-select-start",this[ye].onSelectStart),this[ye].device.removeEventListener("@@webvr-polyfill/input-select-end",this[ye].onSelectEnd),this.dispatchEvent("end",new we("end",{session:this}))),this[ye].stopDeviceFrameLoop(),this[ye].device.endSession(this[ye].id)}updateRenderState(e){if(this[ye].ended){throw new Error("Can't call updateRenderState on an XRSession that has already ended.")}if(e.baseLayer&&e.baseLayer._session!==this){throw new Error("Called updateRenderState with a base layer that was created by a different session.")}if(null!==e.inlineVerticalFieldOfView&&void 0!==e.inlineVerticalFieldOfView){if(this[ye].immersive){throw new Error("inlineVerticalFieldOfView must not be set for an XRRenderState passed to updateRenderState for an immersive session.")}e.inlineVerticalFieldOfView=Math.min(3.13,Math.max(.01,e.inlineVerticalFieldOfView))}if(null===this[ye].pendingRenderState){const e=this[ye].activeRenderState;this[ye].pendingRenderState={depthNear:e.depthNear,depthFar:e.depthFar,inlineVerticalFieldOfView:e.inlineVerticalFieldOfView,baseLayer:e.baseLayer}}Object.assign(this[ye].pendingRenderState,e)}_checkInputSourcesChange(){const e=[],t=[],i=this.inputSources,r=this[ye].currentInputSources;for(const t of i)r.includes(t)||e.push(t);for(const e of r)i.includes(e)||t.push(e);(e.length>0||t.length>0)&&this.dispatchEvent("inputsourceschange",new Se("inputsourceschange",{session:this,added:e,removed:t})),this[ye].currentInputSources.length=0;for(const e of i)this[ye].currentInputSources.push(e)}}const Re=Symbol("@@webxr-polyfill/XRInputSource");const Ee=Symbol("@@webxr-polyfill/XRReferenceSpaceEvent");var Fe={XR:class extends i{constructor(e){super(),this[E]={device:null,devicePromise:e,immersiveSession:null,inlineSessions:new Set},e.then(e=>{this[E].device=e})}async isSessionSupported(e){return this[E].device||await this[E].devicePromise,"inline"!=e?Promise.resolve(this[E].device.isSessionSupported(e)):Promise.resolve(!0)}async requestSession(e,t){if(!this[E].device){if("inline"!=e)throw new Error(P);await this[E].devicePromise}if(!F.includes(e))throw new TypeError(`The provided value '${e}' is not a valid enum value of type XRSessionMode`);const i=M[e],r=i.requiredFeatures.concat(t&&t.requiredFeatures?t.requiredFeatures:[]),n=i.optionalFeatures.concat(t&&t.optionalFeatures?t.optionalFeatures:[]),s=new Set;let o=!1;for(let e of r)this[E].device.isFeatureSupported(e)?s.add(e):(console.error(`The required feature '${e}' is not supported`),o=!0);if(o)throw new DOMException("Session does not support some required features","NotSupportedError");for(let e of n)this[E].device.isFeatureSupported(e)?s.add(e):console.log(`The optional feature '${e}' is not supported`);const a=await this[E].device.requestSession(e,s),l=new XRSession(this[E].device,e,a);"inline"==e?this[E].inlineSessions.add(l):this[E].immersiveSession=l;const c=()=>{"inline"==e?this[E].inlineSessions.delete(l):this[E].immersiveSession=null,l.removeEventListener("end",c)};return l.addEventListener("end",c),l}},XRSession:xe,XRSessionEvent:we,XRFrame:oe,XRView:D,XRViewport:A,XRViewerPose:q,XRWebGLLayer:class{constructor(e,t,i={}){const r=Object.assign({},pe,i);if(!(e instanceof xe))throw new Error("session must be a XRSession");if(e.ended)throw new Error("InvalidStateError");if(t[he]&&!0!==t[ue])throw new Error("InvalidStateError");const n=t.getParameter(t.FRAMEBUFFER_BINDING);this[de]={context:t,config:r,framebuffer:n,session:e}}get context(){return this[de].context}get antialias(){return this[de].config.antialias}get ignoreDepthValues(){return!0}get framebuffer(){return this[de].framebuffer}get framebufferWidth(){return this[de].context.drawingBufferWidth}get framebufferHeight(){return this[de].context.drawingBufferHeight}get _session(){return this[de].session}getViewport(e){return e._getViewport(this)}},XRSpace:S,XRReferenceSpace:R,XRReferenceSpaceEvent:class extends Event{constructor(e,t){super(e,t),this[Ee]={referenceSpace:t.referenceSpace,transform:t.transform||null}}get referenceSpace(){return this[Ee].referenceSpace}get transform(){return this[Ee].transform}},XRInputSource:class{constructor(e){this[Re]={impl:e,gripSpace:new S("grip",this),targetRaySpace:new S("target-ray",this)}}get handedness(){return this[Re].impl.handedness}get targetRayMode(){return this[Re].impl.targetRayMode}get gripSpace(){let e=this[Re].impl.targetRayMode;return"gaze"===e||"screen"===e?null:this[Re].gripSpace}get targetRaySpace(){return this[Re].targetRaySpace}get profiles(){return this[Re].impl.profiles}get gamepad(){return this[Re].impl.gamepad}},XRInputSourceEvent:ve,XRInputSourcesChangeEvent:Se,XRRenderState:ce,XRRigidTransform:w,XRPose:L};const Me=e=>"function"!=typeof e.prototype.makeXRCompatible&&(e.prototype.makeXRCompatible=function(){return this[ue]=!0,Promise.resolve()},!0),Pe=e=>{const t=e.prototype.getContext;e.prototype.getContext=function(e,i){const r=t.call(this,e,i);return r&&(r[he]=!0,i&&"xrCompatible"in i&&(r[ue]=i.xrCompatible)),r}},Xe=async function(e,t){},_e={global:e,webvr:!0,cardboard:!0,cardboardConfig:null,allowCardboardOnDesktop:!1},Oe=["navigator","HTMLCanvasElement","WebGLRenderingContext"];return class{constructor(e={}){this.config=Object.freeze(Object.assign({},_e,e)),this.global=this.config.global,this.nativeWebXR="xr"in this.global.navigator,this.injected=!1,this.nativeWebXR?this._injectCompatibilityShims(this.global):this._injectPolyfill(this.global)}_injectPolyfill(e){if(!Oe.every(t=>!!e[t]))throw new Error(`Global must have the following attributes : ${Oe}`);for(const t of Object.keys(Fe))void 0!==e[t]?console.warn(`${t} already defined on global.`):e[t]=Fe[t];Me(e.WebGLRenderingContext)&&(Pe(e.HTMLCanvasElement),e.OffscreenCanvas&&Pe(e.OffscreenCanvas),e.WebGL2RenderingContext&&Me(e.WebGL2RenderingContext)),this.injected=!0,this._patchNavigatorXR()}_patchNavigatorXR(){let e=Xe(this.global,this.config);this.xr=new Fe.XR(e),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}_injectCompatibilityShims(e){if(!Oe.every(t=>!!e[t]))throw new Error(`Global must have the following attributes : ${Oe}`);if(e.navigator.xr&&"supportsSession"in e.navigator.xr&&!("isSessionSupported"in e.navigator.xr)){let t=e.navigator.xr.supportsSession;e.navigator.xr.isSessionSupported=function(e){return t.call(this,e).then(()=>!0).catch(()=>!1)},e.navigator.xr.supportsSession=function(e){return console.warn("navigator.xr.supportsSession() is deprecated. Please call navigator.xr.isSessionSupported() instead and check the boolean value returned when the promise resolves."),t.call(this,e)}}if(e.XRWebGLLayer){let i=e.navigator.xr.requestSession;e.navigator.xr.requestSession=function(e,t){return i.call(this,e,t).then(t=>(t._session_mode=e,t))};var t=e.XRWebGLLayer;e.XRWebGLLayer=function(e,i,r){return r||(r={}),r.compositionDisabled="inline"===e._session_mode,new t(e,i,r)}}}}});
